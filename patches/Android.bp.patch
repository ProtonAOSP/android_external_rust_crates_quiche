--- Android.bp	2020-12-16 14:02:37.120186423 +0900
+++ Android.bp.new	2020-12-15 22:43:09.717301330 +0900
@@ -1,74 +1,58 @@
 // This file is generated by cargo2android.py --run --device --dependencies --patch=patches/Android.bp.patch.
 
-rust_library_shared {
-    name: "libquiche_shared",
-    stem: "libquiche",
-    host_supported: true,
-    crate_name: "quiche",
-    srcs: ["src/lib.rs"],
-    edition: "2018",
-    features: [
-        "boringssl-vendored",
-        "default",
-    ],
-    rustlibs: [
-        "liblazy_static",
-        "liblibc",
-        "liblibm",
-        "liblog_rust",
-        "libring",
-    ],
-    static_libs: [
-        "libcrypto",
-        "libssl",
+cc_library_headers {
+    name: "libquiche_ffi_headers",
+    export_include_dirs: ["include"],
+    apex_available: [
+        "//apex_available:platform",
+        "com.android.resolv",
     ],
+    min_sdk_version: "29",
 }
 
-rust_library {
-    name: "libquiche",
+rust_defaults {
+    name: "libquiche_defaults",
+    stem: "libquiche",
     host_supported: true,
     crate_name: "quiche",
     srcs: ["src/lib.rs"],
     edition: "2018",
     features: [
-        "boringssl-vendored",
+        "boringssl",
         "default",
     ],
-    rustlibs: [
+
+    // Link all crates statically to create a self-contained .so library.
+    rlibs: [
         "liblazy_static",
         "liblibc",
         "liblibm",
         "liblog_rust",
         "libring",
     ],
-    static_libs: [
+    prefer_rlib: true,
+
+    shared_libs: [
         "libcrypto",
         "libssl",
     ],
-}
 
-rust_library_static {
-    name: "libquiche_static",
-    stem: "libquiche",
-    host_supported: true,
-    crate_name: "quiche",
-    srcs: ["src/lib.rs"],
-    edition: "2018",
-    features: [
-        "boringssl-vendored",
-        "default",
-    ],
-    rustlibs: [
-        "liblazy_static",
-        "liblibc",
-        "liblibm",
-        "liblog_rust",
-        "libring",
-    ],
-    static_libs: [
-        "libcrypto",
-        "libssl",
+    // For DnsResolver (Mainline module introduced in Q).
+    apex_available: [
+        "//apex_available:platform",
+        "com.android.resolv",
     ],
+    min_sdk_version: "29",
+}
+
+rust_ffi {
+    name: "libquiche_ffi",
+    defaults: ["libquiche_defaults"],
+}
+
+rust_library {
+    name: "libquiche",
+    defaults: ["libquiche_defaults"],
 }
 
 // dependent_library ["feature_list"]
